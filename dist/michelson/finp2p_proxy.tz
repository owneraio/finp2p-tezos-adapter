{ parameter
    (or (or (list %cleanup bytes)
            (or %finp2p_admin
               (or (address %update_admin)
                   (pair %update_fa2_token bytes (pair (address %address) (nat %id))))
               (pair %update_operation_ttl (nat %ttl) (nat %allowed_in_the_future))))
        (or (or %finp2p_asset
               (or (pair %create_asset
                      (bytes %asset_id)
                      (pair %new_token_info (pair (address %address) (nat %id)) (map string bytes)))
                   (pair %issue_tokens
                      (pair %nonce (bytes %nonce) (timestamp %timestamp))
                      (pair (bytes %asset_id)
                            (pair (key %dst_account)
                                  (pair (nat %amount) (pair (bytes %shg) (option %signature signature)))))))
               (or (pair %redeem_tokens
                      (pair %nonce (bytes %nonce) (timestamp %timestamp))
                      (pair (bytes %asset_id)
                            (pair (key %src_account) (pair (nat %amount) (signature %signature)))))
                   (pair %transfer_tokens
                      (pair %nonce (bytes %nonce) (timestamp %timestamp))
                      (pair (bytes %asset_id)
                            (pair (key %src_account)
                                  (pair (key %dst_account) (pair (nat %amount) (pair (bytes %shg) (signature %signature)))))))))
            (list %finp2p_batch_asset
               (or (or (pair %create_asset
                          (bytes %asset_id)
                          (pair %new_token_info (pair (address %address) (nat %id)) (map string bytes)))
                       (pair %issue_tokens
                          (pair %nonce (bytes %nonce) (timestamp %timestamp))
                          (pair (bytes %asset_id)
                                (pair (key %dst_account)
                                      (pair (nat %amount) (pair (bytes %shg) (option %signature signature)))))))
                   (or (pair %redeem_tokens
                          (pair %nonce (bytes %nonce) (timestamp %timestamp))
                          (pair (bytes %asset_id)
                                (pair (key %src_account) (pair (nat %amount) (signature %signature)))))
                       (pair %transfer_tokens
                          (pair %nonce (bytes %nonce) (timestamp %timestamp))
                          (pair (bytes %asset_id)
                                (pair (key %src_account)
                                      (pair (key %dst_account) (pair (nat %amount) (pair (bytes %shg) (signature %signature)))))))))))) ;
  storage
    (pair (pair %operation_ttl (nat %ttl) (nat %allowed_in_the_future))
          (pair (big_map %live_operations bytes timestamp)
                (pair (big_map %finp2p_assets bytes (pair (address %address) (nat %id)))
                      (address %admin)))) ;
  code { PUSH string "FINP2P_PASSED_OR_EXPIRED_OPERATION" ;
         PUSH string "FINP2P_UNKNOWN_ASSET_ID" ;
         PUSH string "INVALID_FA2_CONTRACT" ;
         PUSH string "FINP2P_INVALID_SIGNATURE" ;
         SWAP ;
         DUP ;
         DUG 2 ;
         LAMBDA
           (pair string address)
           (contract (list (pair address (list (pair address (pair nat nat))))))
           { UNPAIR ;
             SWAP ;
             CONTRACT %transfer
               (list (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
             IF_NONE { FAILWITH } { SWAP ; DROP } } ;
         SWAP ;
         APPLY ;
         DUP 3 ;
         LAMBDA
           (pair string address)
           (contract (pair nat (pair (option (map string bytes)) (list (pair address nat)))))
           { UNPAIR ;
             SWAP ;
             CONTRACT %mint
               (pair (nat %token_id)
                     (pair (option %token_info (map string bytes)) (list %owners (pair address nat)))) ;
             IF_NONE { FAILWITH } { SWAP ; DROP } } ;
         SWAP ;
         APPLY ;
         LAMBDA (list bytes) bytes { CONCAT } ;
         PUSH (map nat bytes)
              { Elt 0 0x00 ;
                Elt 1 0x01 ;
                Elt 2 0x02 ;
                Elt 3 0x03 ;
                Elt 4 0x04 ;
                Elt 5 0x05 ;
                Elt 6 0x06 ;
                Elt 7 0x07 ;
                Elt 8 0x08 ;
                Elt 9 0x09 ;
                Elt 10 0x0a ;
                Elt 11 0x0b ;
                Elt 12 0x0c ;
                Elt 13 0x0d ;
                Elt 14 0x0e ;
                Elt 15 0x0f ;
                Elt 16 0x10 ;
                Elt 17 0x11 ;
                Elt 18 0x12 ;
                Elt 19 0x13 ;
                Elt 20 0x14 ;
                Elt 21 0x15 ;
                Elt 22 0x16 ;
                Elt 23 0x17 ;
                Elt 24 0x18 ;
                Elt 25 0x19 ;
                Elt 26 0x1a ;
                Elt 27 0x1b ;
                Elt 28 0x1c ;
                Elt 29 0x1d ;
                Elt 30 0x1e ;
                Elt 31 0x1f ;
                Elt 32 0x20 ;
                Elt 33 0x21 ;
                Elt 34 0x22 ;
                Elt 35 0x23 ;
                Elt 36 0x24 ;
                Elt 37 0x25 ;
                Elt 38 0x26 ;
                Elt 39 0x27 ;
                Elt 40 0x28 ;
                Elt 41 0x29 ;
                Elt 42 0x2a ;
                Elt 43 0x2b ;
                Elt 44 0x2c ;
                Elt 45 0x2d ;
                Elt 46 0x2e ;
                Elt 47 0x2f ;
                Elt 48 0x30 ;
                Elt 49 0x31 ;
                Elt 50 0x32 ;
                Elt 51 0x33 ;
                Elt 52 0x34 ;
                Elt 53 0x35 ;
                Elt 54 0x36 ;
                Elt 55 0x37 ;
                Elt 56 0x38 ;
                Elt 57 0x39 ;
                Elt 58 0x3a ;
                Elt 59 0x3b ;
                Elt 60 0x3c ;
                Elt 61 0x3d ;
                Elt 62 0x3e ;
                Elt 63 0x3f ;
                Elt 64 0x40 ;
                Elt 65 0x41 ;
                Elt 66 0x42 ;
                Elt 67 0x43 ;
                Elt 68 0x44 ;
                Elt 69 0x45 ;
                Elt 70 0x46 ;
                Elt 71 0x47 ;
                Elt 72 0x48 ;
                Elt 73 0x49 ;
                Elt 74 0x4a ;
                Elt 75 0x4b ;
                Elt 76 0x4c ;
                Elt 77 0x4d ;
                Elt 78 0x4e ;
                Elt 79 0x4f ;
                Elt 80 0x50 ;
                Elt 81 0x51 ;
                Elt 82 0x52 ;
                Elt 83 0x53 ;
                Elt 84 0x54 ;
                Elt 85 0x55 ;
                Elt 86 0x56 ;
                Elt 87 0x57 ;
                Elt 88 0x58 ;
                Elt 89 0x59 ;
                Elt 90 0x5a ;
                Elt 91 0x5b ;
                Elt 92 0x5c ;
                Elt 93 0x5d ;
                Elt 94 0x5e ;
                Elt 95 0x5f ;
                Elt 96 0x60 ;
                Elt 97 0x61 ;
                Elt 98 0x62 ;
                Elt 99 0x63 ;
                Elt 100 0x64 ;
                Elt 101 0x65 ;
                Elt 102 0x66 ;
                Elt 103 0x67 ;
                Elt 104 0x68 ;
                Elt 105 0x69 ;
                Elt 106 0x6a ;
                Elt 107 0x6b ;
                Elt 108 0x6c ;
                Elt 109 0x6d ;
                Elt 110 0x6e ;
                Elt 111 0x6f ;
                Elt 112 0x70 ;
                Elt 113 0x71 ;
                Elt 114 0x72 ;
                Elt 115 0x73 ;
                Elt 116 0x74 ;
                Elt 117 0x75 ;
                Elt 118 0x76 ;
                Elt 119 0x77 ;
                Elt 120 0x78 ;
                Elt 121 0x79 ;
                Elt 122 0x7a ;
                Elt 123 0x7b ;
                Elt 124 0x7c ;
                Elt 125 0x7d ;
                Elt 126 0x7e ;
                Elt 127 0x7f ;
                Elt 128 0x80 ;
                Elt 129 0x81 ;
                Elt 130 0x82 ;
                Elt 131 0x83 ;
                Elt 132 0x84 ;
                Elt 133 0x85 ;
                Elt 134 0x86 ;
                Elt 135 0x87 ;
                Elt 136 0x88 ;
                Elt 137 0x89 ;
                Elt 138 0x8a ;
                Elt 139 0x8b ;
                Elt 140 0x8c ;
                Elt 141 0x8d ;
                Elt 142 0x8e ;
                Elt 143 0x8f ;
                Elt 144 0x90 ;
                Elt 145 0x91 ;
                Elt 146 0x92 ;
                Elt 147 0x93 ;
                Elt 148 0x94 ;
                Elt 149 0x95 ;
                Elt 150 0x96 ;
                Elt 151 0x97 ;
                Elt 152 0x98 ;
                Elt 153 0x99 ;
                Elt 154 0x9a ;
                Elt 155 0x9b ;
                Elt 156 0x9c ;
                Elt 157 0x9d ;
                Elt 158 0x9e ;
                Elt 159 0x9f ;
                Elt 160 0xa0 ;
                Elt 161 0xa1 ;
                Elt 162 0xa2 ;
                Elt 163 0xa3 ;
                Elt 164 0xa4 ;
                Elt 165 0xa5 ;
                Elt 166 0xa6 ;
                Elt 167 0xa7 ;
                Elt 168 0xa8 ;
                Elt 169 0xa9 ;
                Elt 170 0xaa ;
                Elt 171 0xab ;
                Elt 172 0xac ;
                Elt 173 0xad ;
                Elt 174 0xae ;
                Elt 175 0xaf ;
                Elt 176 0xb0 ;
                Elt 177 0xb1 ;
                Elt 178 0xb2 ;
                Elt 179 0xb3 ;
                Elt 180 0xb4 ;
                Elt 181 0xb5 ;
                Elt 182 0xb6 ;
                Elt 183 0xb7 ;
                Elt 184 0xb8 ;
                Elt 185 0xb9 ;
                Elt 186 0xba ;
                Elt 187 0xbb ;
                Elt 188 0xbc ;
                Elt 189 0xbd ;
                Elt 190 0xbe ;
                Elt 191 0xbf ;
                Elt 192 0xc0 ;
                Elt 193 0xc1 ;
                Elt 194 0xc2 ;
                Elt 195 0xc3 ;
                Elt 196 0xc4 ;
                Elt 197 0xc5 ;
                Elt 198 0xc6 ;
                Elt 199 0xc7 ;
                Elt 200 0xc8 ;
                Elt 201 0xc9 ;
                Elt 202 0xca ;
                Elt 203 0xcb ;
                Elt 204 0xcc ;
                Elt 205 0xcd ;
                Elt 206 0xce ;
                Elt 207 0xcf ;
                Elt 208 0xd0 ;
                Elt 209 0xd1 ;
                Elt 210 0xd2 ;
                Elt 211 0xd3 ;
                Elt 212 0xd4 ;
                Elt 213 0xd5 ;
                Elt 214 0xd6 ;
                Elt 215 0xd7 ;
                Elt 216 0xd8 ;
                Elt 217 0xd9 ;
                Elt 218 0xda ;
                Elt 219 0xdb ;
                Elt 220 0xdc ;
                Elt 221 0xdd ;
                Elt 222 0xde ;
                Elt 223 0xdf ;
                Elt 224 0xe0 ;
                Elt 225 0xe1 ;
                Elt 226 0xe2 ;
                Elt 227 0xe3 ;
                Elt 228 0xe4 ;
                Elt 229 0xe5 ;
                Elt 230 0xe6 ;
                Elt 231 0xe7 ;
                Elt 232 0xe8 ;
                Elt 233 0xe9 ;
                Elt 234 0xea ;
                Elt 235 0xeb ;
                Elt 236 0xec ;
                Elt 237 0xed ;
                Elt 238 0xee ;
                Elt 239 0xef ;
                Elt 240 0xf0 ;
                Elt 241 0xf1 ;
                Elt 242 0xf2 ;
                Elt 243 0xf3 ;
                Elt 244 0xf4 ;
                Elt 245 0xf5 ;
                Elt 246 0xf6 ;
                Elt 247 0xf7 ;
                Elt 248 0xf8 ;
                Elt 249 0xf9 ;
                Elt 250 0xfa ;
                Elt 251 0xfb ;
                Elt 252 0xfc ;
                Elt 253 0xfd ;
                Elt 254 0xfe ;
                Elt 255 0xff } ;
         PUSH (map nat string)
              { Elt 0 "0" ;
                Elt 1 "1" ;
                Elt 2 "2" ;
                Elt 3 "3" ;
                Elt 4 "4" ;
                Elt 5 "5" ;
                Elt 6 "6" ;
                Elt 7 "7" ;
                Elt 8 "8" ;
                Elt 9 "9" ;
                Elt 10 "a" ;
                Elt 11 "b" ;
                Elt 12 "c" ;
                Elt 13 "d" ;
                Elt 14 "e" ;
                Elt 15 "f" } ;
         SWAP ;
         LAMBDA
           (pair (map nat bytes) (pair nat nat))
           bytes
           { UNPAIR ;
             SWAP ;
             UNPAIR ;
             PUSH nat 255 ;
             PUSH nat 8 ;
             DIG 3 ;
             MUL ;
             DIG 2 ;
             LSR ;
             AND ;
             GET ;
             IF_NONE { PUSH string "" ; FAILWITH } {} } ;
         SWAP ;
         APPLY ;
         DUP 3 ;
         SWAP ;
         PAIR ;
         LAMBDA
           (pair (pair (lambda (pair nat nat) bytes) (lambda (list bytes) bytes)) nat)
           bytes
           { UNPAIR ;
             UNPAIR ;
             DIG 2 ;
             PUSH nat 9223372036854775807 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             COMPARE ;
             GT ;
             IF { DROP 3 ; PUSH string "BAD_INT64_NAT" ; FAILWITH }
                { NIL bytes ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 0 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 1 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 2 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 3 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 4 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 5 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  PUSH nat 6 ;
                  SWAP ;
                  PAIR ;
                  DUP 4 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  SWAP ;
                  PUSH nat 7 ;
                  SWAP ;
                  PAIR ;
                  DIG 2 ;
                  SWAP ;
                  EXEC ;
                  CONS ;
                  EXEC } } ;
         SWAP ;
         APPLY ;
         DUP ;
         LAMBDA
           (pair (lambda nat bytes) timestamp)
           bytes
           { UNPAIR ;
             SWAP ;
             PUSH timestamp 0 ;
             SWAP ;
             SUB ;
             ISNAT ;
             IF_NONE { PUSH string "" ; FAILWITH } {} ;
             EXEC } ;
         SWAP ;
         APPLY ;
         LAMBDA
           (pair bytes nat)
           bytes
           { UNPAIR ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SIZE ;
             SUB ;
             ISNAT ;
             IF_NONE { PUSH string "INVALID_DROP_N" ; FAILWITH } {} ;
             DIG 2 ;
             SLICE ;
             IF_NONE { PUSH string "SLICE" ; FAILWITH } {} } ;
         DUP ;
         LAMBDA
           (pair (lambda (pair bytes nat) bytes) key)
           bytes
           { UNPAIR ; SWAP ; PACK ; PUSH nat 7 ; SWAP ; PAIR ; EXEC } ;
         SWAP ;
         APPLY ;
         SWAP ;
         LAMBDA
           (pair (lambda (pair bytes nat) bytes) string)
           bytes
           { UNPAIR ; SWAP ; PACK ; PUSH nat 6 ; SWAP ; PAIR ; EXEC } ;
         SWAP ;
         APPLY ;
         DIG 4 ;
         SWAP ;
         DUP ;
         DUG 2 ;
         PAIR ;
         LAMBDA
           (pair (pair (lambda string bytes) (map nat string)) nat)
           bytes
           { UNPAIR ;
             UNPAIR ;
             DIG 2 ;
             PUSH nat 9223372036854775807 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             COMPARE ;
             GT ;
             IF { DIG 2 ; DROP 2 ; PUSH string "BAD_INT64_NAT" ; FAILWITH }
                { PUSH nat 0 ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  COMPARE ;
                  EQ ;
                  IF { DIG 2 ; DROP 2 ; PUSH string "0x0" }
                     { NIL string ;
                       PUSH nat 15 ;
                       DIG 2 ;
                       PAIR ;
                       PAIR ;
                       LEFT string ;
                       LOOP_LEFT
                         { UNPAIR ;
                           UNPAIR ;
                           PUSH nat 15 ;
                           PUSH nat 4 ;
                           DUP 4 ;
                           MUL ;
                           DUP 3 ;
                           LSR ;
                           AND ;
                           DUP 6 ;
                           SWAP ;
                           GET ;
                           IF_NONE { PUSH string "" ; FAILWITH } {} ;
                           PUSH string "0" ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           COMPARE ;
                           EQ ;
                           IF { DUP 4 ; IF_CONS { DROP 2 ; DIG 3 ; SWAP ; CONS } { DROP ; DIG 2 } }
                              { DIG 3 ; SWAP ; CONS } ;
                           PUSH nat 1 ;
                           DIG 3 ;
                           SUB ;
                           ISNAT ;
                           IF_NONE
                             { SWAP ;
                               DROP ;
                               NIL string ;
                               SWAP ;
                               ITER { CONS } ;
                               PUSH string "0x" ;
                               CONS ;
                               CONCAT ;
                               RIGHT (pair (pair nat nat) (list string)) }
                             { DIG 2 ; PAIR ; PAIR ; LEFT string } } ;
                       DIG 2 ;
                       DROP } } ;
             EXEC } ;
         SWAP ;
         APPLY ;
         LAMBDA
           (pair (pair nat nat)
                 (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address)))
           unit
           { GET 6 ;
             SENDER ;
             COMPARE ;
             EQ ;
             NOT ;
             IF { PUSH string "FINP2P_UNAUTHORIZED_ACTION" ; FAILWITH } { UNIT } } ;
         LAMBDA
           (pair timestamp
                 (pair (pair nat nat)
                       (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address))))
           bool
           { UNPAIR ; SWAP ; CAR ; CAR ; INT ; ADD ; NOW ; COMPARE ; GT } ;
         DUP ;
         LAMBDA
           (pair (lambda
                    (pair timestamp
                          (pair (pair nat nat)
                                (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address))))
                    bool)
                 (pair timestamp
                       (pair (pair nat nat)
                             (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address)))))
           bool
           { UNPAIR ;
             SWAP ;
             UNPAIR ;
             DUP ;
             DUP 3 ;
             SWAP ;
             PAIR ;
             DIG 3 ;
             SWAP ;
             EXEC ;
             NOT ;
             DIG 2 ;
             CAR ;
             CDR ;
             INT ;
             NOW ;
             ADD ;
             DIG 2 ;
             COMPARE ;
             LE ;
             AND } ;
         SWAP ;
         APPLY ;
         LAMBDA key address { HASH_KEY ; IMPLICIT_ACCOUNT ; ADDRESS } ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DUP 16 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 15 ;
         DIG 13 ;
         DIG 13 ;
         PAIR 14 ;
         LAMBDA
           (pair (pair (lambda key address)
                       (pair (lambda
                                (pair timestamp
                                      (pair (pair nat nat)
                                            (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address))))
                                bool)
                             (pair (lambda nat bytes)
                                   (pair (lambda string bytes)
                                         (pair (lambda key bytes)
                                               (pair (lambda timestamp bytes)
                                                     (pair (lambda nat bytes)
                                                           (pair (lambda (list bytes) bytes)
                                                                 (pair (lambda
                                                                          address
                                                                          (contract (pair nat (pair (option (map string bytes)) (list (pair address nat))))))
                                                                       (pair (lambda address (contract (list (pair address (list (pair address (pair nat nat)))))))
                                                                             (pair string (pair string (pair string string)))))))))))))
                 (pair (or (or (pair bytes (pair (pair address nat) (map string bytes)))
                               (pair (pair bytes timestamp)
                                     (pair bytes (pair key (pair nat (pair bytes (option signature)))))))
                           (or (pair (pair bytes timestamp) (pair bytes (pair key (pair nat signature))))
                               (pair (pair bytes timestamp)
                                     (pair bytes (pair key (pair key (pair nat (pair bytes signature))))))))
                       (pair (pair nat nat)
                             (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address)))))
           (pair operation
                 (pair (pair nat nat)
                       (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address))))
           { UNPAIR ;
             UNPAIR 14 ;
             DIG 14 ;
             UNPAIR ;
             IF_LEFT
               { DIG 8 ;
                 DIG 11 ;
                 DIG 13 ;
                 DROP 3 ;
                 IF_LEFT
                   { DIG 2 ;
                     DIG 3 ;
                     DIG 4 ;
                     DIG 5 ;
                     DIG 6 ;
                     DIG 7 ;
                     DIG 8 ;
                     DIG 10 ;
                     DIG 11 ;
                     DIG 12 ;
                     DROP 10 ;
                     DUP ;
                     CDR ;
                     UNPAIR ;
                     DUP 4 ;
                     GET 5 ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     SOME ;
                     DIG 4 ;
                     CAR ;
                     GET_AND_UPDATE ;
                     IF_NONE {} { DROP ; PUSH string "FINP2P_ASSET_ALREADY_EXISTS" ; FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     DIG 5 ;
                     SWAP ;
                     EXEC ;
                     PUSH mutez 0 ;
                     DIG 3 ;
                     CDR ;
                     DIG 4 ;
                     SOME ;
                     NIL (pair address nat) ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     TRANSFER_TOKENS ;
                     DUG 2 ;
                     UPDATE 5 ;
                     SWAP ;
                     PAIR }
                   { DUP ;
                     CAR ;
                     CDR ;
                     DUP 3 ;
                     SWAP ;
                     PAIR ;
                     DIG 4 ;
                     SWAP ;
                     EXEC ;
                     NOT ;
                     IF { DIG 11 ; FAILWITH } { DIG 11 ; DROP } ;
                     DUP ;
                     UNPAIR 6 ;
                     DIG 5 ;
                     DROP ;
                     DUP ;
                     CDR ;
                     DIG 12 ;
                     SWAP ;
                     EXEC ;
                     SWAP ;
                     CAR ;
                     CONCAT ;
                     PUSH string "issue" ;
                     DUP 11 ;
                     SWAP ;
                     EXEC ;
                     PUSH string "finp2p" ;
                     DUP 12 ;
                     SWAP ;
                     EXEC ;
                     PUSH string "finId" ;
                     DIG 12 ;
                     SWAP ;
                     EXEC ;
                     DIG 5 ;
                     DIG 12 ;
                     SWAP ;
                     EXEC ;
                     DIG 6 ;
                     DIG 11 ;
                     SWAP ;
                     EXEC ;
                     NIL bytes ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DIG 4 ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DIG 5 ;
                     SWAP ;
                     EXEC ;
                     BLAKE2B ;
                     CONCAT ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET 10 ;
                     IF_NONE
                       { DIG 5 ; DROP ; UNIT }
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         SWAP ;
                         DUP 4 ;
                         GET 5 ;
                         CHECK_SIGNATURE ;
                         NOT ;
                         IF { DIG 5 ; FAILWITH } { DIG 5 ; DROP ; UNIT } } ;
                     DROP ;
                     DUP 3 ;
                     GET 5 ;
                     DUP 3 ;
                     GET 3 ;
                     GET ;
                     IF_NONE { DIG 5 ; FAILWITH } { DIG 6 ; DROP } ;
                     DUP ;
                     CDR ;
                     NONE (map string bytes) ;
                     NIL (pair address nat) ;
                     DUP 6 ;
                     GET 7 ;
                     DUP 7 ;
                     GET 5 ;
                     DIG 9 ;
                     SWAP ;
                     EXEC ;
                     PAIR ;
                     CONS ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     DIG 5 ;
                     SWAP ;
                     EXEC ;
                     PUSH mutez 0 ;
                     DIG 2 ;
                     TRANSFER_TOKENS ;
                     DIG 3 ;
                     DUP ;
                     GET 3 ;
                     DIG 4 ;
                     CAR ;
                     CDR ;
                     DIG 4 ;
                     BLAKE2B ;
                     SWAP ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     UPDATE 3 ;
                     SWAP ;
                     PAIR } }
               { DIG 10 ;
                 DROP ;
                 IF_LEFT
                   { DIG 6 ;
                     DIG 8 ;
                     DIG 10 ;
                     DROP 3 ;
                     DUP ;
                     CAR ;
                     CDR ;
                     DUP 3 ;
                     SWAP ;
                     PAIR ;
                     DIG 4 ;
                     SWAP ;
                     EXEC ;
                     NOT ;
                     IF { DIG 10 ; FAILWITH } { DIG 10 ; DROP } ;
                     DUP ;
                     UNPAIR 5 ;
                     DIG 2 ;
                     DIG 4 ;
                     DROP 2 ;
                     DUP ;
                     CDR ;
                     DIG 9 ;
                     SWAP ;
                     EXEC ;
                     SWAP ;
                     CAR ;
                     CONCAT ;
                     PUSH string "redeem" ;
                     DIG 8 ;
                     SWAP ;
                     EXEC ;
                     DIG 3 ;
                     DIG 7 ;
                     SWAP ;
                     EXEC ;
                     NIL bytes ;
                     SWAP ;
                     CONS ;
                     DIG 3 ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DIG 4 ;
                     SWAP ;
                     EXEC ;
                     DUP ;
                     DUP 3 ;
                     GET 8 ;
                     DUP 4 ;
                     GET 5 ;
                     CHECK_SIGNATURE ;
                     NOT ;
                     IF { DROP ; DIG 3 ; FAILWITH } { DIG 4 ; DROP ; BLAKE2B } ;
                     DIG 2 ;
                     DUP ;
                     GET 3 ;
                     DUP 4 ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     SWAP ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     UPDATE 3 ;
                     DUP ;
                     GET 5 ;
                     DUP 3 ;
                     GET 3 ;
                     GET ;
                     IF_NONE { DIG 4 ; FAILWITH } { DIG 5 ; DROP } ;
                     DUP ;
                     CDR ;
                     NIL (pair address nat) ;
                     DUP 5 ;
                     GET 7 ;
                     DIG 5 ;
                     GET 5 ;
                     DIG 6 ;
                     SWAP ;
                     EXEC ;
                     PAIR ;
                     CONS ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     CONTRACT %burn (pair (nat %token_id) (list %owners (pair address nat))) ;
                     IF_NONE { DIG 2 ; FAILWITH } { DIG 3 ; DROP } ;
                     PUSH mutez 0 ;
                     DIG 2 ;
                     TRANSFER_TOKENS ;
                     PAIR }
                   { DIG 12 ;
                     DROP ;
                     DUP ;
                     CAR ;
                     CDR ;
                     DUP 3 ;
                     SWAP ;
                     PAIR ;
                     DIG 4 ;
                     SWAP ;
                     EXEC ;
                     NOT ;
                     IF { DIG 12 ; FAILWITH } { DIG 12 ; DROP } ;
                     DUP ;
                     UNPAIR 7 ;
                     DIG 6 ;
                     DROP ;
                     DUP ;
                     CDR ;
                     DIG 13 ;
                     SWAP ;
                     EXEC ;
                     SWAP ;
                     CAR ;
                     CONCAT ;
                     PUSH string "transfer" ;
                     DUP 12 ;
                     SWAP ;
                     EXEC ;
                     PUSH string "finp2p" ;
                     DUP 13 ;
                     SWAP ;
                     EXEC ;
                     PUSH string "finId" ;
                     DIG 13 ;
                     SWAP ;
                     EXEC ;
                     DIG 5 ;
                     DUP 14 ;
                     SWAP ;
                     EXEC ;
                     DIG 6 ;
                     DIG 13 ;
                     SWAP ;
                     EXEC ;
                     DIG 7 ;
                     DIG 12 ;
                     SWAP ;
                     EXEC ;
                     NIL bytes ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DUP 3 ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DIG 4 ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     SWAP ;
                     CONS ;
                     DIG 6 ;
                     SWAP ;
                     EXEC ;
                     BLAKE2B ;
                     CONCAT ;
                     DUP ;
                     DUP 3 ;
                     GET 12 ;
                     DUP 4 ;
                     GET 5 ;
                     CHECK_SIGNATURE ;
                     NOT ;
                     IF { DROP ; DIG 5 ; FAILWITH } { DIG 6 ; DROP ; BLAKE2B } ;
                     DIG 2 ;
                     DUP ;
                     GET 3 ;
                     DUP 4 ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     SWAP ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     UPDATE 3 ;
                     DUP ;
                     GET 5 ;
                     DUP 3 ;
                     GET 3 ;
                     GET ;
                     IF_NONE { DIG 5 ; FAILWITH } { DIG 6 ; DROP } ;
                     DUP 3 ;
                     GET 9 ;
                     DUP ;
                     DIG 6 ;
                     SWAP ;
                     EXEC ;
                     DROP ;
                     DUP 4 ;
                     GET 5 ;
                     DUP 6 ;
                     SWAP ;
                     EXEC ;
                     NIL (pair address (pair nat nat)) ;
                     DIG 5 ;
                     GET 7 ;
                     DIG 6 ;
                     SWAP ;
                     EXEC ;
                     DUP 5 ;
                     CDR ;
                     DIG 4 ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     CONS ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     CAR ;
                     DIG 3 ;
                     SWAP ;
                     EXEC ;
                     PUSH mutez 0 ;
                     NIL (pair address (list (pair address (pair nat nat)))) ;
                     DIG 3 ;
                     CONS ;
                     TRANSFER_TOKENS ;
                     PAIR } } } ;
         SWAP ;
         APPLY ;
         DIG 4 ;
         UNPAIR ;
         IF_LEFT
           { DIG 2 ;
             DROP ;
             IF_LEFT
               { DIG 3 ;
                 DIG 4 ;
                 DROP 2 ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET 3 ;
                 SWAP ;
                 ITER { SWAP ;
                        DUP ;
                        DUP 3 ;
                        GET ;
                        IF_NONE
                          { SWAP ; DROP }
                          { DUP 4 ;
                            SWAP ;
                            PAIR ;
                            DUP 5 ;
                            SWAP ;
                            EXEC ;
                            IF { SWAP ; NONE timestamp ; SWAP ; UPDATE } { SWAP ; DROP } } } ;
                 DIG 2 ;
                 DROP ;
                 UPDATE 3 ;
                 NIL operation ;
                 PAIR }
               { DIG 2 ;
                 DROP ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 DIG 3 ;
                 SWAP ;
                 EXEC ;
                 DROP ;
                 IF_LEFT
                   { IF_LEFT
                       { DIG 2 ; DROP ; UPDATE 6 }
                       { UNPAIR ;
                         DIG 3 ;
                         DUG 2 ;
                         PAIR 3 ;
                         LAMBDA
                           (pair (pair bytes
                                       (pair (pair address nat)
                                             (lambda address (contract (list (pair address (list (pair address (pair nat nat)))))))))
                                 (pair (pair nat nat)
                                       (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address))))
                           (pair (pair nat nat)
                                 (pair (big_map bytes timestamp) (pair (big_map bytes (pair address nat)) address)))
                           { UNPAIR ;
                             UNPAIR 3 ;
                             DIG 3 ;
                             DUP 3 ;
                             CAR ;
                             DIG 4 ;
                             SWAP ;
                             EXEC ;
                             DROP ;
                             DUP ;
                             GET 5 ;
                             DIG 3 ;
                             DIG 3 ;
                             SWAP ;
                             SOME ;
                             SWAP ;
                             UPDATE ;
                             UPDATE 5 } ;
                         SWAP ;
                         APPLY ;
                         SWAP ;
                         EXEC } }
                   { DIG 2 ; DROP ; UPDATE 1 } ;
                 NIL operation ;
                 PAIR } }
           { DIG 3 ;
             DIG 5 ;
             DROP 2 ;
             IF_LEFT
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 DIG 4 ;
                 SWAP ;
                 EXEC ;
                 DROP ;
                 PAIR ;
                 EXEC ;
                 UNPAIR ;
                 SWAP ;
                 NIL operation ;
                 DIG 2 ;
                 CONS ;
                 PAIR }
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 DIG 4 ;
                 SWAP ;
                 EXEC ;
                 DROP ;
                 SWAP ;
                 NIL operation ;
                 PAIR ;
                 SWAP ;
                 ITER { SWAP ;
                        UNPAIR ;
                        DUG 2 ;
                        SWAP ;
                        PAIR ;
                        DUP 3 ;
                        SWAP ;
                        EXEC ;
                        UNPAIR ;
                        SWAP ;
                        DUG 2 ;
                        CONS ;
                        PAIR } ;
                 SWAP ;
                 DROP } } } ;
  view "get_asset_balance"
       (pair key bytes)
       nat
       { UNPAIR ;
         UNPAIR ;
         HASH_KEY ;
         IMPLICIT_ACCOUNT ;
         ADDRESS ;
         DIG 2 ;
         GET 5 ;
         DIG 2 ;
         GET ;
         IF_NONE { PUSH string "FINP2P_UNKNOWN_ASSET_ID" ; FAILWITH } {} ;
         DUP ;
         CAR ;
         SWAP ;
         CDR ;
         DIG 2 ;
         PAIR ;
         VIEW "get_balance" nat ;
         IF_NONE { PUSH string "UNAVAILBLE_ASSET_BALANCE" ; FAILWITH } {} } }

